<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestural Symphony 3.0</title>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.4/p5.min.js"></script>
  <script src="https://unpkg.com/ml5@1.0.1/dist/ml5.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>

  <style>
    body { margin: 0; padding: 0; background: #050505; overflow: hidden; font-family: 'Helvetica Neue', sans-serif; }
    
    /* Loading / Start Overlay */
    #overlay {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.95);
      backdrop-filter: blur(5px);
      display: flex; flex-direction: column; justify-content: center; align-items: center;
      z-index: 100; color: white; transition: opacity 0.8s ease;
    }
    
    .instruction-card {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      padding: 30px;
      border-radius: 12px;
      max-width: 600px;
      text-align: center;
      margin-bottom: 30px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    }

    h1 { letter-spacing: 3px; font-weight: 300; margin-bottom: 20px; color: #fff; }
    p { color: #aaa; line-height: 1.6; margin: 10px 0; font-size: 16px; }
    strong { color: #00ffcc; }

    /* The Button */
    button {
      padding: 16px 40px; font-size: 16px; cursor: pointer;
      background: transparent; color: #666; 
      border: 1px solid #444; font-weight: 600; letter-spacing: 1px;
      border-radius: 50px; transition: all 0.3s ease;
      text-transform: uppercase;
      pointer-events: none; /* Locked until AI loads */
    }

    /* Active State */
    button.ready {
      background: #00ffcc; color: #000; border-color: #00ffcc;
      pointer-events: all; box-shadow: 0 0 30px rgba(0, 255, 204, 0.4);
    }
    button.ready:hover { transform: scale(1.05); background: #fff; box-shadow: 0 0 50px rgba(255, 255, 255, 0.6); }

    /* Heads Up Display */
    #hud {
      position: absolute; bottom: 30px; left: 30px; color: rgba(255,255,255,0.5);
      font-family: monospace; font-size: 12px; pointer-events: none;
      text-transform: uppercase; letter-spacing: 1px;
    }

    /* Back Button */
    #exit {
      position: absolute; top: 20px; right: 20px; text-decoration: none;
      color: rgba(255,255,255,0.3); font-size: 24px; z-index: 200;
    }
    #exit:hover { color: white; }
  </style>
</head>
<body>

<a href="/" id="exit">✕</a>

<div id="overlay">
  <div class="instruction-card">
    <h1>Gestural Symphony</h1>
    <p>✋ <strong>LEFT HAND:</strong> Pinch index & thumb to play synth. <br>Move Up/Down for Pitch. Move Side-to-Side for Distortion.</p>
    <p>✊ <strong>RIGHT HAND:</strong> Rotate wrist to warp time. <br>Open/Close hand to control volume.</p>
  </div>
  <button id="startBtn">Initializing AI...</button>
</div>

<div id="hud">System Standby</div>

<script>
// --- MANUAL CONNECTION MAP (Fixes the crash) ---
const HAND_CONNECTIONS = [
  [0, 1], [1, 2], [2, 3], [3, 4],       // Thumb
  [0, 5], [5, 6], [6, 7], [7, 8],       // Index
  [0, 9], [9, 10], [10, 11], [11, 12],  // Middle
  [0, 13], [13, 14], [14, 15], [15, 16],// Ring
  [0, 17], [17, 18], [18, 19], [19, 20] // Pinky
];

// --- VARIABLES ---
let video;
let handPose;
let hands = [];
let modelsLoaded = false;
let isRunning = false;

// Audio
let synth, drumKit, metal, distEffect, reverb, loop;
let volNode;

function preload() {
  // Load HandPose with flipped video setting
  handPose = ml5.handPose({ flipped: true, maxHands: 2 });
}

function setup() {
  createCanvas(windowWidth, windowHeight);
  
  // Setup Webcam
  video = createCapture(VIDEO, { flipped: true });
  video.size(640, 480);
  video.hide();

  // Start Detection
  handPose.detectStart(video, gotHands);
}

function gotHands(results) {
  hands = results;
  
  // Only enable button once the first detection happens (ensures AI is ready)
  if (!modelsLoaded) {
    modelsLoaded = true;
    let btn = document.getElementById('startBtn');
    btn.innerText = "Start Experience";
    btn.classList.add("ready");
    
    // Attach Click Event ONLY when ready
    btn.addEventListener('click', initAudioAndStart);
  }
}

// --- AUDIO INITIALIZATION ---
async function initAudioAndStart() {
  // 1. Resume Context (Fixes "AudioContext was not allowed to start")
  await Tone.start();
  console.log("Audio Context Started");

  // 2. Setup Instruments
  distEffect = new Tone.Distortion(0.0).toDestination();
  reverb = new Tone.Reverb(2.5).connect(distEffect);
  
  synth = new Tone.DuoSynth({
    vibratoAmount: 0.5,
    vibratoRate: 5,
    harmonicity: 1.5,
    voice0: { volume: -10, oscillator: { type: "sawtooth" } },
    voice1: { volume: -10, oscillator: { type: "sine" } }
  }).connect(reverb);

  drumKit = new Tone.MembraneSynth({ volume: -20 }).toDestination();
  metal = new Tone.MetalSynth({ 
    frequency: 200, envelope: { decay: 0.1, release: 0.1 }, volume: -25 
  }).toDestination();

  // 3. Setup Loop (Fixes timing warning by using 'time' param)
  loop = new Tone.Loop((time) => {
    drumKit.triggerAttackRelease("C1", "8n", time);
    if (Math.random() > 0.6) {
      metal.triggerAttackRelease("32n", time + 0.25); // Off-beat hi-hat
    }
  }, "4n");

  Tone.Transport.bpm.value = 100;
  Tone.Transport.start();
  loop.start(0);

  // 4. UI Transition
  isRunning = true;
  document.getElementById('overlay').style.opacity = '0';
  setTimeout(() => {
    document.getElementById('overlay').style.display = 'none';
  }, 800);
}

function draw() {
  background(10, 10, 15); // Slightly blue-black

  // Draw Video (Subtle)
  push();
  tint(255, 40); 
  image(video, 0, 0, width, height);
  pop();

  if (isRunning && hands.length > 0) {
    processInteraction();
  } else if (isRunning) {
    document.getElementById('hud').innerText = "LOOKING FOR HANDS...";
  }
}

function processInteraction() {
  let statusText = "";

  for (let hand of hands) {
    // Mirroring logic: 'Left' detected is actually user's Right hand on screen
    let isRightHand = hand.handedness === "Left"; 
    let isLeftHand = hand.handedness === "Right";

    let index = hand.keypoints[8];
    let thumb = hand.keypoints[4];
    let wrist = hand.keypoints[0];
    let middle = hand.keypoints[9]; // Middle finger base/tip helper

    // Map coordinates to screen
    let ix = map(index.x, 0, video.width, 0, width);
    let iy = map(index.y, 0, video.height, 0, height);
    let wx = map(wrist.x, 0, video.width, 0, width);
    let wy = map(wrist.y, 0, video.height, 0, height);

    // Draw Skeleton
    drawSkeleton(hand, isLeftHand ? [0, 255, 200] : [255, 0, 100]);

    // --- LEFT HAND LOGIC (SYNTH) ---
    if (isLeftHand) {
      let pinchDist = dist(index.x, index.y, thumb.x, thumb.y);
      
      // Visual Pinch Line
      if(pinchDist < 60) {
         stroke(0, 255, 200, map(pinchDist, 0, 60, 255, 0));
         let tx = map(thumb.x, 0, video.width, 0, width);
         let ty = map(thumb.y, 0, video.height, 0, height);
         line(ix, iy, tx, ty);
      }

      if (pinchDist < 30) { // Pinch Trigger
        let note = map(iy, height, 0, 100, 700);
        let distAmt = map(ix, 0, width, 0, 0.8);
        
        // Trigger synth if not already sounding (or update params)
        synth.triggerAttack(note, Tone.now()); 
        distEffect.distortion = distAmt;

        // Visual Feedback
        noFill(); stroke(0, 255, 200);
        circle(ix, iy, 40 + random(10));
        statusText += "MELODY ACTIVE | ";
      } else {
        synth.triggerRelease(Tone.now() + 0.1);
      }
    }

    // --- RIGHT HAND LOGIC (RHYTHM) ---
    if (isRightHand) {
      // Rotation Calculation (Angle between Wrist and Middle Finger Knuckle)
      // Index 9 is middle finger MCP (knuckle)
      let midKnuckle = hand.keypoints[9];
      let ang = atan2(midKnuckle.y - wrist.y, midKnuckle.x - wrist.x);
      
      // Map angle to BPM (approx -1.5 to 1.5 range usually)
      let targetBPM = map(ang, -2, 2, 60, 200);
      targetBPM = constrain(targetBPM, 50, 250);
      
      // Smoothly ramp BPM
      Tone.Transport.bpm.rampTo(targetBPM, 0.2);

      // Volume Control (Hand Openness)
      let spread = dist(index.x, index.y, wrist.x, wrist.y);
      let vol = map(spread, 50, 150, -30, 0);
      drumKit.volume.rampTo(constrain(vol, -60, 0), 0.1);

      // Visuals
      push();
      translate(wx, wy);
      rotate(ang);
      stroke(255, 0, 100, 100);
      line(0, 0, 80, 0); // Dial Needle
      noStroke(); fill(255, 0, 100);
      text(Math.round(targetBPM) + " BPM", 90, 5);
      pop();
      
      statusText += `RHYTHM: ${Math.round(targetBPM)} BPM`;
    }
  }

  document.getElementById('hud').innerText = statusText || "Ready for Input";
}

// --- SAFE SKELETON DRAWER ---
function drawSkeleton(hand, colorVals) {
  stroke(colorVals[0], colorVals[1], colorVals[2], 200);
  strokeWeight(2);
  
  // Use our HARDCODED connection map
  for (let i = 0; i < HAND_CONNECTIONS.length; i++) {
    let pair = HAND_CONNECTIONS[i];
    let a = hand.keypoints[pair[0]];
    let b = hand.keypoints[pair[1]];
    
    // Map raw video coords to canvas
    let x1 = map(a.x, 0, video.width, 0, width);
    let y1 = map(a.y, 0, video.height, 0, height);
    let x2 = map(b.x, 0, video.width, 0, width);
    let y2 = map(b.y, 0, video.height, 0, height);
    
    line(x1, y1, x2, y2);
  }
  
  // Draw Joints
  noStroke();
  fill(colorVals[0], colorVals[1], colorVals[2]);
  for (let j = 0; j < hand.keypoints.length; j++) {
    let kp = hand.keypoints[j];
    let x = map(kp.x, 0, video.width, 0, width);
    let y = map(kp.y, 0, video.height, 0, height);
    circle(x, y, 5);
  }
}

function windowResized() {
  resizeCanvas(windowWidth, windowHeight);
}
</script>
</body>
</html>