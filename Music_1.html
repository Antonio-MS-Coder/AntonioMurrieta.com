<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestural Symphony - Neon Resonator</title>
  
  <link rel="icon" href="data:,">
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.4/p5.min.js"></script>
  <script src="https://unpkg.com/ml5@1.0.1/dist/ml5.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>

  <style>
    body { margin: 0; padding: 0; background: #000; overflow: hidden; font-family: 'Helvetica Neue', sans-serif; }
    
    /* Loading Overlay */
    #overlay {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.9);
      backdrop-filter: blur(8px);
      display: flex; flex-direction: column; justify-content: center; align-items: center;
      z-index: 100; color: white; transition: opacity 0.8s ease;
    }
    
    .instruction-card {
      background: linear-gradient(145deg, rgba(255,255,255,0.05), rgba(255,255,255,0.01));
      border: 1px solid rgba(0, 255, 255, 0.2);
      padding: 30px; border-radius: 16px; max-width: 600px;
      text-align: center; margin-bottom: 40px;
      box-shadow: 0 0 30px rgba(0, 255, 255, 0.1);
    }

    h1 { letter-spacing: 2px; font-weight: 300; margin-bottom: 20px; color: #00ffff; text-transform: uppercase; }
    p { color: #ccc; line-height: 1.6; margin: 15px 0; font-size: 16px; }
    .highlight-l { color: #00ffff; font-weight: bold; }
    .highlight-r { color: #ff0055; font-weight: bold; }

    /* Button */
    button {
      padding: 18px 50px; font-size: 16px; cursor: pointer;
      background: transparent; color: #555; 
      border: 2px solid #444; font-weight: 700; letter-spacing: 2px;
      border-radius: 50px; transition: all 0.3s ease;
      text-transform: uppercase; pointer-events: none;
    }
    button.ready {
      border-color: #00ffff; color: #00ffff; pointer-events: all;
      box-shadow: 0 0 20px rgba(0, 255, 255, 0.3);
    }
    button.ready:hover {
      background: #00ffff; color: #000; box-shadow: 0 0 60px rgba(0, 255, 255, 0.8);
    }

    #hud { position: absolute; bottom: 20px; left: 20px; color: rgba(255,255,255,0.4); font-family: monospace; font-size: 12px; pointer-events: none; }
    #exit { position: absolute; top: 20px; right: 20px; text-decoration: none; color: rgba(255,255,255,0.3); font-size: 24px; z-index: 200; }
  </style>
</head>
<body>

<a href="/" id="exit">✕</a>

<div id="overlay">
  <div class="instruction-card">
    <h1>Neon Resonator</h1>
    <p>✋ <span class="highlight-l">LEFT HAND (Melody):</span> Pinch Index & Thumb to pluck strings. <br>Move Up/Down to change notes.</p>
    <p>✊ <span class="highlight-r">RIGHT HAND (Rhythm):</span> Rotate wrist to change speed. <br>Open/Close hand to change volume.</p>
  </div>
  <button id="startBtn">Loading AI Models...</button>
</div>

<div id="hud">System Standby</div>

<script>
// --- MANUAL CONNECTION MAP ---
const HAND_CONNECTIONS = [
  [0, 1], [1, 2], [2, 3], [3, 4], [0, 5], [5, 6], [6, 7], [7, 8],
  [0, 9], [9, 10], [10, 11], [11, 12], [0, 13], [13, 14], [14, 15], [15, 16],
  [0, 17], [17, 18], [18, 19], [19, 20]
];

// --- GLOBAL VARIABLES ---
let video, handPose, hands = [];
let modelsLoaded = false, isRunning = false;
let particles = []; 

// Audio Nodes
let pluckSynth, drumKit, metalLoop;
let pingPongDelay, reverbMaster;

// --- SETUP ---
function preload() {
  handPose = ml5.handPose({ flipped: true, maxHands: 2 });
}

function setup() {
  createCanvas(windowWidth, windowHeight);
  video = createCapture(VIDEO, { flipped: true });
  video.size(640, 480);
  video.hide();
  
  handPose.detectStart(video, gotHands);
}

function gotHands(results) {
  hands = results;
  if (!modelsLoaded && hands.length > -1) {
    modelsLoaded = true;
    let btn = document.getElementById('startBtn');
    btn.innerText = "ENTER EXPERIENCE";
    btn.classList.add("ready");
    btn.addEventListener('click', initAudioAndStart);
  }
}

async function initAudioAndStart() {
  await Tone.start();
  
  // Audio Chain
  reverbMaster = new Tone.Reverb({ decay: 4, wet: 0.5 }).toDestination();
  pingPongDelay = new Tone.PingPongDelay({ delayTime: "8n", feedback: 0.4, wet: 0.3 }).connect(reverbMaster);

  // Melody Instrument
  pluckSynth = new Tone.PluckSynth({
    attackNoise: 1, dampening: 4000, resonance: 0.9
  }).connect(pingPongDelay);
  pluckSynth.volume.value = -5;

  // Rhythm Instruments
  drumKit = new Tone.MembraneSynth({ volume: -20 }).toDestination();
  let hat = new Tone.MetalSynth({ frequency: 200, envelope: { decay: 0.05 }, volume: -25 }).toDestination();

  // Loop
  metalLoop = new Tone.Loop((time) => {
    drumKit.triggerAttackRelease("C1", "8n", time);
    if (Math.random() > 0.5) hat.triggerAttackRelease("32n", time + 0.25);
  }, "4n");

  Tone.Transport.bpm.value = 110;
  Tone.Transport.start();
  metalLoop.start(0);

  // Transition
  isRunning = true;
  document.getElementById('overlay').style.opacity = '0';
  setTimeout(() => { document.getElementById('overlay').style.display = 'none'; }, 800);
}

// --- DRAW LOOP ---
function draw() {
  background(0, 15); // Trail effect

  if (isRunning) {
    updateAndDrawParticles();
    
    if(hands.length > 0) {
      processInteraction();
    } else {
      document.getElementById('hud').innerText = "SCANNING SPACE...";
    }
  }
}

// --- INTERACTION ---
function processInteraction() {
  let statusText = "";

  for (let hand of hands) {
    let isRightHandScreen = hand.handedness === "Left"; 
    let isLeftHandScreen = hand.handedness === "Right";

    let index = hand.keypoints[8];
    let thumb = hand.keypoints[4];
    let wrist = hand.keypoints[0];
    let midKnuckle = hand.keypoints[9];

    // Coordinates
    let ix = map(index.x, 0, video.width, 0, width);
    let iy = map(index.y, 0, video.height, 0, height);
    let tx = map(thumb.x, 0, video.width, 0, width);
    let ty = map(thumb.y, 0, video.height, 0, height);
    let wx = map(wrist.x, 0, video.width, 0, width);
    let wy = map(wrist.y, 0, video.height, 0, height);

    // Draw Skeleton
    let handColor = isLeftHandScreen ? [0, 255, 255] : [255, 0, 85];
    drawNeonSkeleton(hand, handColor);

    // --- LEFT HAND (MELODY) ---
    if (isLeftHandScreen) {
      let pinchDist = dist(index.x, index.y, thumb.x, thumb.y);
      
      // Visual Connection
      if(pinchDist < 80) {
         let brightness = map(pinchDist, 0, 80, 255, 50);
         stroke(0, 255, 255, brightness); strokeWeight(2);
         line(ix, iy, tx, ty);
      }

      // Trigger Note
      if (pinchDist < 25) { 
        // Pentatonic Scale
        let notes = ["C3", "D3", "E3", "G3", "A3", "C4", "D4", "E4"];
        let noteIndex = floor(map(iy, height, 0, 0, notes.length));
        noteIndex = constrain(noteIndex, 0, notes.length -1);
        let selectedNote = notes[noteIndex];

        pluckSynth.triggerAttack(selectedNote, Tone.now());
        spawnParticles((ix+tx)/2, (iy+ty)/2, handColor, 10);
        statusText += `PLUCKING: ${selectedNote} | `;
      }
    }

    // --- RIGHT HAND (RHYTHM) ---
    if (isRightHandScreen) {
      let ang = atan2(midKnuckle.y - wrist.y, midKnuckle.x - wrist.x);
      let targetBPM = map(ang, -2, 2, 60, 220);
      targetBPM = constrain(targetBPM, 60, 220);
      Tone.Transport.bpm.rampTo(targetBPM, 0.1);

      let spread = dist(index.x, index.y, wrist.x, wrist.y);
      let vol = map(spread, 40, 140, -40, -5);
      drumKit.volume.rampTo(constrain(vol, -60, 0), 0.1);

      // Visuals
      let dialX = wx + cos(ang) * 80;
      let dialY = wy + sin(ang) * 80;
      if(frameCount % 5 === 0) spawnParticles(dialX, dialY, handColor, 2, true);

      push();
      translate(wx, wy); rotate(ang);
      fill(handColor); noStroke(); textSize(14);
      text(Math.round(targetBPM), 90, 5);
      pop();
      statusText += `BPM: ${Math.round(targetBPM)}`;
    }
  }
  document.getElementById('hud').innerText = statusText;
}

// --- PARTICLE SYSTEM ---
class Particle {
  // FIXED TYPO BELOW: 'isSubtle'
  constructor(x, y, colorVals, isSubtle) {
    this.pos = createVector(x, y);
    this.vel = p5.Vector.random2D().mult(random(1, 5));
    this.color = colorVals;
    this.life = 255;
    this.size = random(4, 12);
    this.isSubtle = isSubtle; 
  }

  update() {
    this.pos.add(this.vel);
    this.life -= this.isSubtle ? 15 : 8; 
    this.size *= 0.95; 
  }

  draw() {
    noStroke();
    fill(this.color[0], this.color[1], this.color[2], this.life * 0.5);
    circle(this.pos.x, this.pos.y, this.size * 1.5);
    fill(255, 255, 255, this.life); 
    circle(this.pos.x, this.pos.y, this.size);
  }
}

function spawnParticles(x, y, color, count, subtle = false) {
  for (let i = 0; i < count; i++) {
    particles.push(new Particle(x, y, color, subtle));
  }
}

function updateAndDrawParticles() {
  for (let i = particles.length - 1; i >= 0; i--) {
    particles[i].update();
    particles[i].draw();
    if (particles[i].life <= 0) particles.splice(i, 1);
  }
}

// --- SKELETON DRAWER ---
function drawNeonSkeleton(hand, c) {
  stroke(c[0], c[1], c[2], 80); strokeWeight(8);
  drawLines(hand);
  stroke(c[0], c[1], c[2], 200); strokeWeight(3);
  drawLines(hand);
  
  noStroke();
  for (let k of hand.keypoints) {
    let x = map(k.x, 0, video.width, 0, width);
    let y = map(k.y, 0, video.height, 0, height);
    fill(c[0], c[1], c[2], 100); circle(x, y, 12);
    fill(255, 255, 255, 200); circle(x, y, 5);
  }
}

function drawLines(hand) {
   for (let i = 0; i < HAND_CONNECTIONS.length; i++) {
    let pair = HAND_CONNECTIONS[i];
    let a = hand.keypoints[pair[0]]; let b = hand.keypoints[pair[1]];
    line(map(a.x,0,video.width,0,width), map(a.y,0,video.height,0,height), 
         map(b.x,0,video.width,0,width), map(b.y,0,video.height,0,height));
  }
}

function windowResized() { resizeCanvas(windowWidth, windowHeight); }
</script>
</body>
</html>