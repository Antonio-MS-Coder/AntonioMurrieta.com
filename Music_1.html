<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestural Symphony 2.0</title>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.4/p5.min.js"></script>
  <script src="https://unpkg.com/ml5@1.0.1/dist/ml5.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>

  <style>
    body { margin: 0; padding: 0; background: #000; overflow: hidden; font-family: sans-serif; }
    
    #overlay {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.95);
      display: flex; flex-direction: column; justify-content: center; align-items: center;
      z-index: 10; color: white; transition: opacity 0.5s;
    }
    
    .instruction-grid {
      display: grid; grid-template-columns: 1fr 1fr; gap: 20px; max-width: 600px;
      text-align: left; margin-bottom: 30px;
    }
    .inst-box { border: 1px solid #333; padding: 15px; border-radius: 8px; background: #111; }
    h2 { color: #00ffcc; margin-top: 0; font-size: 18px; }
    
    button {
      padding: 15px 40px; font-size: 18px; cursor: pointer;
      background: #444; color: #888; border: none; font-weight: bold;
      border-radius: 30px; transition: all 0.3s;
    }
    button.ready { background: #00ffcc; color: #000; box-shadow: 0 0 25px #00ffcc; }
    
    #hud {
      position: absolute; bottom: 20px; left: 20px; color: #00ffcc;
      font-family: monospace; font-size: 14px; pointer-events: none;
    }
  </style>
</head>
<body>

<div id="overlay">
  <h1>GESTURAL SYMPHONY 2.0</h1>
  
  <div class="instruction-grid">
    <div class="inst-box">
      <h2>ðŸ‘ˆ LEFT HAND (Melody)</h2>
      <p>â€¢ <b>PINCH (Thumb+Index)</b> to Play Sound.</p>
      <p>â€¢ <b>Move Up/Down:</b> Change Pitch.</p>
      <p>â€¢ <b>Move Left/Right:</b> Change Distortion.</p>
    </div>
    <div class="inst-box">
      <h2>ðŸ‘‰ RIGHT HAND (Rhythm)</h2>
      <p>â€¢ <b>Rotate Wrist:</b> Warps Time (Speed).</p>
      <p>â€¢ <b>Open/Close Hand:</b> Controls Drum Volume.</p>
    </div>
  </div>

  <button id="startBtn">LOADING AI...</button>
</div>

<div id="hud">Waiting for input...</div>

<script>
// --- CONFIGURATION ---
let video;
let handPose;
let hands = [];
let modelsLoaded = false;
let isAudioStarted = false;

// --- AUDIO NODES ---
let synth; // The Pinch Synth
let beat;  // The Background Loop
let drumKit; 
let distEffect; // Distortion
let volNode; // Master Volume

// --- STATE TRACKING ---
let currentBPM = 120;
let isPinching = false;
let pinchDist = 0;

function preload() {
  handPose = ml5.handPose({ flipped: true, maxHands: 2 });
}

function setup() {
  createCanvas(windowWidth, windowHeight);
  video = createCapture(VIDEO, { flipped: true });
  video.size(640, 480);
  video.hide();

  handPose.detectStart(video, (results) => {
    hands = results;
    if(!modelsLoaded) {
      modelsLoaded = true;
      let btn = document.getElementById('startBtn');
      btn.innerText = "START EXPERIENCE";
      btn.classList.add("ready");
      btn.onclick = startSystem;
    }
  });
}

// --- AUDIO ENGINE ---
async function startSystem() {
  await Tone.start();
  
  // 1. Synth (Theremin style)
  distEffect = new Tone.Distortion(0.0).toDestination();
  let reverb = new Tone.Reverb(2).connect(distEffect);
  
  synth = new Tone.DuoSynth({
    vibratoAmount: 0.5,
    vibratoRate: 5,
    harmonicity: 1.5,
    voice0: { volume: -10, oscillator: { type: "sawtooth" } },
    voice1: { volume: -10, oscillator: { type: "sine" } }
  }).connect(reverb);

  // 2. Drums (Rhythm)
  drumKit = new Tone.MembraneSynth({ volume: -20 }).toDestination();
  let metal = new Tone.MetalSynth({ 
    frequency: 200, envelope: { decay: 0.1, release: 0.1 }, volume: -15 
  }).toDestination();

  // Create a Loop
  beat = new Tone.Loop(time => {
    drumKit.triggerAttackRelease("C1", "8n", time);
    if (Math.random() > 0.5) metal.triggerAttackRelease("32n", time + 0.25);
  }, "4n").start(0);

  Tone.Transport.start();
  
  isAudioStarted = true;
  document.getElementById('overlay').style.opacity = 0;
  setTimeout(() => document.getElementById('overlay').style.display = 'none', 500);
}

function draw() {
  background(10);
  
  // Draw Video Feintly
  push();
  tint(100, 100); 
  image(video, 0, 0, width, height);
  pop();

  if (!isAudioStarted) return;

  // Process Hands
  handleGestures();
}

function handleGestures() {
  let hudText = "";

  for (let hand of hands) {
    // Identify Left vs Right (Note: 'Left' in ml5 is usually the person's left)
    let isRight = hand.handedness === "Left"; // Mirroring quirk: Left on screen is Right Hand
    let isLeft = hand.handedness === "Right"; // Right on screen is Left Hand
    
    let index = hand.keypoints[8];
    let thumb = hand.keypoints[4];
    let wrist = hand.keypoints[0];
    let middle = hand.keypoints[9];

    let x = map(index.x, 0, video.width, 0, width);
    let y = map(index.y, 0, video.height, 0, height);
    let wx = map(wrist.x, 0, video.width, 0, width);
    let wy = map(wrist.y, 0, video.height, 0, height);

    drawHandSkeleton(hand, isLeft ? [0, 255, 200] : [255, 0, 100]);

    // --- LEFT HAND: THE PINCH SYNTH ---
    if (isLeft) {
      // 1. Calculate Pinch
      let pDist = dist(index.x, index.y, thumb.x, thumb.y);
      let pinchThreshold = 30; // How close needs to be to count as pinch
      
      if (pDist < pinchThreshold) {
        // PINCHED: PLAY SOUND
        let note = map(y, height, 0, 100, 800); // Y = Pitch
        let distortion = map(x, 0, width, 0, 1); // X = Distortion
        
        synth.triggerAttack(note, Tone.now());
        distEffect.distortion = distortion;
        
        // Visuals
        noFill(); stroke(0, 255, 200); strokeWeight(3);
        circle(x, y, 50 + Math.random()*20);
        hudText += "LEFT: PLAYING | ";
      } else {
        // RELEASED
        synth.triggerRelease(Tone.now() + 0.1);
        hudText += "LEFT: HOVER | ";
      }
    }

    // --- RIGHT HAND: THE TIME WARPER ---
    if (isRight) {
      // 1. Rotation (Angle between Wrist and Middle Finger)
      let angle = atan2(middle.y - wrist.y, middle.x - wrist.x);
      // Map angle to BPM (roughly -1.5 to 1.5 radians)
      let newBPM = map(angle, -2, 2, 60, 300);
      newBPM = constrain(newBPM, 60, 400);
      
      Tone.Transport.bpm.rampTo(newBPM, 0.1);
      
      // 2. Open Hand vs Closed (Volume)
      // Check distance of fingertips to wrist
      let spread = dist(index.x, index.y, wrist.x, wrist.y);
      let vol = map(spread, 50, 150, -30, 0); // Open = Loud, Fist = Quiet
      drumKit.volume.rampTo(constrain(vol, -60, 0), 0.1);

      // Visuals for Rotation
      push();
      translate(wx, wy);
      rotate(angle);
      stroke(255, 0, 100, 100); strokeWeight(2);
      line(0, 0, 100, 0); // Angle indicator
      noStroke(); fill(255, 0, 100);
      text(Math.floor(newBPM) + " BPM", 110, 0);
      pop();
      
      hudText += "RIGHT: " + Math.floor(newBPM) + " BPM";
    }
  }
  
  document.getElementById('hud').innerText = hudText;
}

// Stylized Skeleton Drawer
function drawHandSkeleton(hand, color) {
  stroke(color[0], color[1], color[2], 150);
  strokeWeight(2);
  
  // Draw Connections
  let connections = ml5.handPose.getConnections();
  for (let i = 0; i < connections.length; i++) {
    let pointA = hand.keypoints[connections[i][0]];
    let pointB = hand.keypoints[connections[i][1]];
    
    let x1 = map(pointA.x, 0, video.width, 0, width);
    let y1 = map(pointA.y, 0, video.height, 0, height);
    let x2 = map(pointB.x, 0, video.width, 0, width);
    let y2 = map(pointB.y, 0, video.height, 0, height);
    
    line(x1, y1, x2, y2);
  }
  
  // Draw Joints
  noStroke();
  fill(color);
  for (let k of hand.keypoints) {
    let x = map(k.x, 0, video.width, 0, width);
    let y = map(k.y, 0, video.height, 0, height);
    circle(x, y, 6);
  }
}

function windowResized() { resizeCanvas(windowWidth, windowHeight); }
</script>
</body>
</html>