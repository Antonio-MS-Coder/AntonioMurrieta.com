<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>The Invisible Instrument</title>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.4/p5.min.js"></script>
  <script src="https://unpkg.com/ml5@1.0.1/dist/ml5.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>

  <style>
    body {
      margin: 0;
      padding: 0;
      background-color: #111;
      overflow: hidden;
      font-family: 'Courier New', Courier, monospace;
      color: white;
    }
    
    /* Overlay for Start/Loading */
    #overlay {
      position: absolute;
      top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.9);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 10;
      text-align: center;
      transition: opacity 0.5s;
    }

    h1 { margin-bottom: 10px; text-transform: uppercase; letter-spacing: 2px; }
    p { color: #aaa; margin-bottom: 30px; }

    /* The Button */
    #startBtn {
      padding: 15px 40px;
      font-size: 18px;
      cursor: pointer;
      background: #444; /* Grey initially */
      color: #888;
      border: 1px solid #555;
      font-weight: bold;
      pointer-events: none; /* Disabled initially */
      transition: all 0.3s;
      border-radius: 5px;
    }

    /* Button Active State */
    #startBtn.ready {
      background: #00ffcc;
      color: #000;
      border: none;
      pointer-events: all;
      box-shadow: 0 0 20px rgba(0, 255, 204, 0.5);
    }

    #startBtn.ready:hover {
      transform: scale(1.05);
      background: #fff;
    }

    /* Back Button */
    #closeBtn {
      position: absolute;
      top: 20px; right: 20px;
      color: white;
      text-decoration: none;
      font-size: 24px;
      font-weight: bold;
      z-index: 20;
      opacity: 0.5;
    }
    #closeBtn:hover { opacity: 1; }
  </style>
</head>
<body>

<a href="/" id="closeBtn" title="Back to Portfolio">✕</a>

<div id="overlay">
  <h1>The Invisible Instrument</h1>
  <p>Camera access required • Use Headphones</p>
  
  <button id="startBtn">LOADING AI MODELS...</button>
</div>

<script>
// --- GLOBAL VARIABLES ---
let video;
let handPose;
let faceMesh;
let hands = [];
let faces = [];
let modelsLoaded = false;

// Audio Components
let synth, drum, filter, reverb;
let isAudioStarted = false;

// Tracking State
let prevHandX = 0;
let prevHandY = 0;

// Visuals
let particles = [];

function preload() {
  // Load the models
  handPose = ml5.handPose({ flipped: true });
  faceMesh = ml5.faceMesh({ flipped: true });
}

function setup() {
  createCanvas(windowWidth, windowHeight);
  
  // Webcam Setup
  video = createCapture(VIDEO, { flipped: true });
  video.size(640, 480);
  video.hide();

  // Start Tracking
  handPose.detectStart(video, (results) => {
    hands = results;
    checkLoadStatus();
  });
  
  faceMesh.detectStart(video, (results) => {
    faces = results;
    checkLoadStatus();
  });
}

// Check if we are receiving data, then enable button
function checkLoadStatus() {
  if (!modelsLoaded) {
    modelsLoaded = true;
    let btn = document.getElementById('startBtn');
    btn.innerText = "CLICK TO START";
    btn.classList.add("ready");
    btn.onclick = startExperience;
  }
}

// --- AUDIO SETUP (Tone.js) ---
async function startAudio() {
  await Tone.start();
  
  // 1. The Melodic Synth
  filter = new Tone.AutoFilter({
    frequency: 1,
    baseFrequency: 200,
    octaves: 2.6
  }).toDestination().start();
  
  reverb = new Tone.Reverb({ decay: 1.5, preDelay: 0.01 }).connect(filter);
  
  synth = new Tone.PolySynth(Tone.Synth, {
    oscillator: { type: "sawtooth" },
    envelope: { attack: 0.1, decay: 0.1, sustain: 0.3, release: 1 }
  }).connect(reverb);

  // 2. The Drum
  drum = new Tone.MembraneSynth().toDestination();

  isAudioStarted = true;
}

function startExperience() {
  startAudio();
  // Fade out overlay
  document.getElementById('overlay').style.opacity = '0';
  setTimeout(() => {
    document.getElementById('overlay').style.display = 'none';
  }, 500);
}

function draw() {
  background(20);
  
  // Draw Video (Ghostly effect)
  push();
  tint(255, 80); 
  image(video, 0, 0, width, height);
  pop();

  drawZones();

  if (isAudioStarted) {
    handleHands();
    handleFace();
  }

  updateParticles();
}

// --- LOGIC ---

function drawZones() {
  stroke(255, 30);
  strokeWeight(1);
  line(width/2, 0, width/2, height);
  line(0, height/2, width, height/2);
  
  noStroke();
  fill(255, 50);
  textSize(14);
  text("PITCH", 20, 30);
  text("FX / REVERB", width/2 + 20, height/2 + 30);
}

function handleHands() {
  if (hands.length > 0) {
    let hand = hands[0];
    let indexFinger = hand.keypoints[8]; 
    
    // Normalize coordinates to canvas size
    // Note: Video is 640x480, we map to window size
    let x = map(indexFinger.x, 0, video.width, 0, width);
    let y = map(indexFinger.y, 0, video.height, 0, height);

    // Marker
    fill(0, 255, 200);
    circle(x, y, 15);

    // Zone 1: Pitch (Top Left)
    if (x < width/2 && y < height/2) {
      let note = map(y, height/2, 0, 200, 800); 
      synth.set({ oscillator: { type: "sine" } });
      synth.triggerAttackRelease(note, "8n");
      stroke(0, 255, 200, 100);
      line(x, y, 0, y);
    }

    // Zone 2: Reverb (Bottom Right)
    if (x > width/2 && y > height/2) {
      let damp = map(y, height/2, height, 0.1, 5);
      reverb.decay = damp;
      fill(255, 0, 100, 50);
      circle(x, y, damp * 30);
    }

    // Velocity / Drum
    let vel = dist(x, y, prevHandX, prevHandY);
    if (vel > 60) { // Speed threshold
      drum.triggerAttackRelease("C1", "8n");
      createParticle(x, y);
    }

    prevHandX = x;
    prevHandY = y;
  }
}

function handleFace() {
  if (faces.length > 0) {
    let face = faces[0];
    
    // Lip points
    let topLip = face.keypoints[13];
    let bottomLip = face.keypoints[14];
    
    // Calculate mouth opening
    // We map raw video coordinates to create a ratio
    let mouthDist = dist(topLip.x, topLip.y, bottomLip.x, bottomLip.y);
    
    if (mouthDist > 15) { 
       let freq = map(mouthDist, 15, 80, 200, 3000);
       filter.baseFrequency = freq;
       
       noFill();
       stroke(255, 255, 0);
       let visualX = map(topLip.x, 0, video.width, 0, width);
       let visualY = map(topLip.y, 0, video.height, 0, height);
       circle(visualX, visualY, mouthDist * 5);
    } else {
       filter.baseFrequency = 200;
    }
  }
}

function createParticle(x, y) {
  particles.push({ x: x, y: y, size: 50, life: 255 });
}

function updateParticles() {
  for (let i = particles.length - 1; i >= 0; i--) {
    let p = particles[i];
    noStroke();
    fill(255, p.life);
    circle(p.x, p.y, p.size);
    p.size += 3;
    p.life -= 15;
    if (p.life <= 0) particles.splice(i, 1);
  }
}

function windowResized() {
  resizeCanvas(windowWidth, windowHeight);
}
</script>
</body>
</html>